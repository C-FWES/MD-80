<?xml version="1.0"?>

<!-- McDonnell Douglas MD-80 DFGS -->
<!-- Copyright (c) 2021 Josh Davidson (Octal450) -->

<system name="MD-80: DFGS">
	
	<!-- Default gains for tuning -->
	<property value="0">dfgs/yaw/yd-p-gain-tune</property>
	<property value="0">dfgs/yaw/tc-p-gain-tune</property>
	<property value="0">dfgs/yaw/tc-d-gain-tune</property>
	
	<!-- DFGS stuff -->
	<property value="0">dfgs/mach-trim/output</property>
	<property value="0">dfgs/afs/roll-cmd</property>
	<property value="0">dfgs/afs/pitch-cmd</property>
	<property value="0">dfgs/afs/yaw-cmd</property>
	
	<channel name="Libraries">
		
		<switch name="dfgs/afs/enabled">
			<default value="0"/>
			<test logic="OR" value="1">
				/it-autoflight/output/ap1 eq 1
				/it-autoflight/output/ap2 eq 1
			</test>
		</switch>
		
		<switch name="aero/alpha-deg-fixed">
			<default value="0"/>
			<test value="aero/alpha-deg">
				gear/unit[0]/WOW eq 0
			</test>
		</switch>
		
		<lag_filter name="aero/alpha-deg-damped">
			<input>aero/alpha-deg-fixed</input>
			<c1>10</c1>
		</lag_filter>
	
	</channel>
	
	<channel name="Envelope Protection Calculations" execrate="8">
		
		<fcs_function name="dfgs/speeds/vss-kts"> <!-- From FCOM -->
			<function>
				<table>
					<independentVar lookup="row">inertia/weight-lbs</independentVar>
					<independentVar lookup="column">fcs/flap-pos-deg</independentVar>
					<independentVar lookup="table">fcs/slat-pos-deg</independentVar>
					<tableData breakPoint="0">
						        0    11   15   28   40
						 90000  132  122  119  112  106
						 95000  136  125  123  116  109
						100000  139  128  126  118  112
						105000  143  132  129  122  114
						110000  146  135  132  124  117
						115000  149  138  135  127  120
						120000  152  141  138  130  122
						125000  156  143  141  133  125
						130000  159  146  143  135  127
						135000  162  149  146  138  130
						140000  165  152  149  141  132
						145000  168  155  152  143  135
					</tableData>
					<tableData breakPoint="31">
						        0    11   15   28   40
						 90000  104   98   96   92   89
						 95000  107  101   99   94   92
						100000  110  104  102   97   94
						105000  112  106  104   99   96
						110000  115  109  107  101   99
						115000  117  111  109  104  101
						120000  120  114  111  106  103
						125000  122  116  113  108  105
						130000  125  118  116  110  107
						135000  127  120  118  112  109
						140000  129  122  120  114  111
						145000  132  124  122  116  113
					</tableData>
				</table>
			</function>
		</fcs_function>
		
		<fcs_function name="dfgs/speeds/vss-roll-factor"> <!-- Not 100% sure the 80 does this, but I assume it does -->
			<function>
				<sqrt> <!-- Take the square root to get the factor -->
					<quotient> <!-- Calculate neutral load factor from bank -->
						<value>1</value>
						<cos>
							<toradians>
								<min>
									<abs><property>/orientation/roll-deg</property></abs>
									<value>45</value> <!-- Otherwise problems happen -->
								</min>
							</toradians>
						</cos>
					</quotient>
				</sqrt>
			</function>
		</fcs_function>
		
		<pure_gain name="dfgs/speeds/vss">
			<input>dfgs/speeds/vss-kts</input>
			<gain>dfgs/speeds/vss-roll-factor</gain>
		</pure_gain>
		
		<pure_gain name="dfgs/speeds/vmin">
			<input>dfgs/speeds/vss-kts</input>
			<gain>1.2</gain> <!-- 1.2Vstall -->
			<clipto>
				<min>dfgs/speeds/vss</min>
				<max>100000</max>
			</clipto>
		</pure_gain>
		
		<fcs_function name="dfgs/speeds/vmin-mach">
			<function>
				<sum>
					<product>
						<quotient>
							<property>/instrumentation/airspeed-indicator/indicated-mach</property>
							<max> <!-- Prevent divide by 0 -->
								<property>/instrumentation/airspeed-indicator/indicated-speed-kt</property>
								<value>0.0001</value>
							</max>
						</quotient>
						<property>dfgs/speeds/vmin</property>
					</product>
					<value>0.005</value>
				</sum>
			</function>
		</fcs_function>
		
		<pure_gain name="dfgs/speeds/vss1_3">
			<input>dfgs/speeds/vss-kts</input>
			<gain>1.3</gain> <!-- 1.3Vstall -->
			<clipto>
				<min>dfgs/speeds/vss</min>
				<max>100000</max>
			</clipto>
		</pure_gain>
	
	</channel>
	
	<channel name="Yaw Damper Logic">
		
		<switch name="dfgs/yaw/active">
			<default value="0"/>
			<test value="0">
				position/wow eq 1
				/position/gear-agl-ft lt 50
			</test>
			<test logic="AND" value="1">
				/controls/fctl/yd eq 1
				dfgs/afs/enabled eq 1
			</test>
			<test value="1">
				/controls/fctl/yd eq 2
			</test>
		</switch>
	
	</channel>
	
	<channel name="Gains">
		
		<fcs_function name="dfgs/yaw/yd-p-gain">
			<function>
				<product>
					<table>
						<independentVar lookup="row">velocities/vc-kts</independentVar>
						<tableData>
							130 -8.5
							350 -1.0
						</tableData>
					</table>
					<!--property>dfgs/yaw/yd-p-gain-tune</property--> <!-- For tuning -->
					<property>dfgs/yaw/active</property>
				</product>
			</function>
		</fcs_function>
		
		<fcs_function name="dfgs/yaw/tc-p-gain">
			<function>
				<product>
					<table>
						<independentVar lookup="row">velocities/vc-kts</independentVar>
						<tableData>
							130  2.0
							350  0.5
						</tableData>
					</table>
					<!--property>dfgs/yaw/tc-p-gain-tune</property--> <!-- For tuning -->
					<property>dfgs/yaw/active</property>
				</product>
			</function>
		</fcs_function>
		
		<fcs_function name="dfgs/yaw/tc-d-gain">
			<function>
				<product>
					<table>
						<independentVar lookup="row">velocities/vc-kts</independentVar>
						<tableData>
							130  4
							350  1
						</tableData>
					</table>
					<!--property>dfgs/yaw/tc-d-gain-tune</property--> <!-- For tuning -->
					<property>dfgs/yaw/active</property>
				</product>
			</function>
		</fcs_function>
	
	</channel>
	
	<channel name="DFGS: Stick Pusher">
		
		<switch name="dfgs/stick-pusher/alpha-latch">
			<default value="dfgs/stick-pusher/alpha-latch"/>
			<test value="0">
				position/wow eq 1
			</test>
			<test logic="AND" value="0">
				aero/alpha-deg gt 12
				aero/alpha-deg le 15
			</test>
			<test logic="AND" value="1">
				aero/alpha-deg gt 18
				position/wow ne 1
			</test>
		</switch>
		
		<switch name="dfgs/stick-pusher/active">
			<default value="0"/>
			<test value="1"> <!-- TODO: Add electrical etc -->
				dfgs/stick-pusher/alpha-latch eq 1
			</test>
		</switch>
		
		<actuator name="dfgs/stick-pusher/output">
			<input>dfgs/stick-pusher/active</input>
			<rate_limit sense="incr">5.0</rate_limit>
			<rate_limit sense="decr">1000</rate_limit>
		</actuator>
	
	</channel>
	
	<channel name="DFGS: Yaw Axis and Yaw Damper">
		
		<switch name="dfgs/yaw/autoland-switch">
			<default value="0"/>
			<test logic="AND" value="1">
				dfgs/afs/enabled eq 1
				/it-autoflight/output/lat eq 4
			</test>
		</switch>
		
		<fcs_function name="dfgs/yaw/rudder-nul">
			<function>
				<table>
					<independentVar lookup="row">/controls/flight/rudder</independentVar>
					<independentVar lookup="column">dfgs/yaw/autoland-switch</independentVar>
					<tableData>
						       0  1
						-1.00 -1  0
						-0.02  0  0
						 0.02  0  0
						 1.00  1  0
					</tableData>
				</table>
			</function>
		</fcs_function>
		
		<washout_filter name="dfgs/yaw/r-washout">
			<input>velocities/r-rad_sec</input>
			<c1>0.5</c1>
		</washout_filter>
		
		<switch name="dfgs/yaw/r-switched">
			<default value="dfgs/yaw/r-washout"/>
			<test logic="OR" value="0">
				dfgs/yaw/active ne 1
				dfgs/yaw/autoland-switch eq 1
			</test>
		</switch>
		
		<pure_gain name="dfgs/yaw/yd-f">
			<input>dfgs/yaw/r-switched</input>
			<gain>dfgs/yaw/yd-p-gain</gain>
			<clipto>
				<min>-0.5</min>
				<max>0.5</max>
			</clipto>
		</pure_gain>
		
		<switch name="dfgs/yaw/slip-skid">
			<default value="aero/beta-rad"/>
			<test logic="OR" value="0">
				position/wow eq 1
			</test>
		</switch>
		
		<pid name="dfgs/yaw/tc-pd-v">
			<input>dfgs/yaw/slip-skid</input>
			<kp>dfgs/yaw/tc-p-gain</kp>
			<ki>0.0</ki>
			<kd>dfgs/yaw/tc-d-gain</kd>
			<clipto>
				<min>-0.2</min>
				<max>0.2</max>
			</clipto>
			<output>dfgs/yaw/tc-pd</output>
		</pid>
		
		<switch name="dfgs/yaw/tc-pd-s">
			<default value="dfgs/yaw/tc-pd"/>
			<test logic="OR" value="0">
				dfgs/yaw/active ne 1
				dfgs/yaw/autoland-switch eq 1
			</test>
		</switch>
		
		<switch name="dfgs/yaw/afs-cmd">
			<default value="0"/>
			<test value="dfgs/afs/yaw-cmd">
				dfgs/yaw/autoland-switch eq 1
			</test>
		</switch>
		
		<summer name="dfgs/yaw/output-sum">
			<input>dfgs/yaw/yd-f</input>
			<input>dfgs/yaw/tc-pd-s</input>
			<input>dfgs/yaw/afs-cmd</input>
		</summer>
		
		<switch name="dfgs/yaw/output">
			<default value="dfgs/yaw/output-sum"/>
			<test value="dfgs/yaw/afs-cmd"> <!-- DFGS keeps working even if YD is unavail -->
				/controls/fctl/yd eq 0
			</test>
		</switch>
		
		<summer name="dfgs/rudder-output">
			<input>dfgs/yaw/rudder-nul</input>
			<input>dfgs/yaw/output</input>
			<clipto>
				<min>-1.0</min>
				<max>1.0</max>
			</clipto>
		</summer>
	
	</channel>

</system>
